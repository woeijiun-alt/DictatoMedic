<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedicoDictate - AI Medical Dictation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .glowing-border {
            box-shadow: 0 0 15px 2px rgba(239, 68, 68, 0.6);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px 2px rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.8); }
            100% { box-shadow: 0 0 15px 2px rgba(239, 68, 68, 0.6); }
        }
        .summary-heading {
            font-weight: bold;
            text-decoration: underline;
            color: #7dd3fc;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 1.1rem;
        }
        .typo-warning {
            background-color: #fef3c7;
            color: #92400e;
            border-bottom: 2px dashed #f59e0b;
            padding: 0 2px;
            border-radius: 2px;
        }
        #summary-content { outline: none; min-height: 100%; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="text-slate-200">
    <div class="min-h-screen flex flex-col items-center p-4 py-8">
        <header class="text-center mb-8 relative w-full max-w-7xl">
            <div class="flex items-center justify-center gap-3 mb-2">
                <i data-lucide="activity" class="text-sky-400 w-10 h-10"></i>
                <h1 class="text-4xl font-bold text-white tracking-tight">MedicoDictate</h1>
            </div>
            <p class="text-lg text-slate-400">Clinical AI Scribe</p>
            <button id="open-settings-btn" class="absolute right-0 top-0 p-2 text-slate-400 hover:text-white">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </header>

        <main class="w-full max-w-7xl flex flex-col gap-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Dictation -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-white">Live Dictation</h2>
                        <div id="status-indicator" class="w-4 h-4 bg-slate-500 rounded-full"></div>
                    </div>
                    <textarea id="dictation-box" class="w-full h-96 bg-slate-900 border border-slate-700 rounded-lg p-4 focus:ring-2 focus:ring-sky-500 text-base resize-none" placeholder="Start speaking..."></textarea>
                    <div class="mt-4 flex gap-3">
                        <button id="start-btn" class="flex-1 flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-500 py-3 rounded-lg font-bold transition-all">
                            <i data-lucide="mic"></i> <span>Start Recording</span>
                        </button>
                        <button id="summarise-btn" disabled class="flex-1 flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <i data-lucide="wand-2"></i> <span>Process Note</span>
                        </button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700 flex flex-col">
                    <h2 class="text-xl font-semibold text-white mb-4">Structured Note <span class="text-xs font-normal text-slate-500 italic">(Editable)</span></h2>
                    <div id="summary-container" class="flex-grow bg-slate-900 border border-slate-700 rounded-lg p-4 overflow-y-auto relative min-h-[384px]">
                        <div id="loading-spinner" class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/80 z-10">
                            <div class="flex flex-col items-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-sky-500 mb-2"></div>
                                <p class="text-sky-400 text-sm font-medium">AI is thinking...</p>
                            </div>
                        </div>
                        <div id="summary-content" contenteditable="true" class="text-slate-300"></div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <button id="copy-btn" disabled class="bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm font-medium disabled:opacity-30">Copy Text</button>
                        <button id="save-txt-btn" disabled class="bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm font-medium disabled:opacity-30">Export .txt</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center pb-10">
                <button id="new-session-btn" class="flex items-center gap-2 bg-amber-600/20 hover:bg-amber-600 text-amber-500 hover:text-white px-8 py-3 rounded-xl border border-amber-600/30 transition-all">
                    <i data-lucide="trash-2"></i> Reset Session
                </button>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-xl max-w-md w-full p-6 modal-enter">
            <h3 class="text-xl font-bold text-white mb-4">Gemini API Configuration</h3>
            <p class="text-sm text-slate-400 mb-4">Your key is required for AI summarization. It is stored only in your local browser.</p>
            <input type="password" id="api-key-input" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white mb-4 outline-none focus:border-sky-500" placeholder="Paste AIza... key here">
            <div class="flex justify-end gap-3">
                <button id="close-settings-btn" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button id="save-settings-btn" class="bg-sky-600 px-6 py-2 rounded-lg text-white font-bold">Save Key</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const startBtn = document.getElementById('start-btn');
            const summariseBtn = document.getElementById('summarise-btn');
            const dictationBox = document.getElementById('dictation-box');
            const summaryContent = document.getElementById('summary-content');
            const statusIndicator = document.getElementById('status-indicator');
            const loadingSpinner = document.getElementById('loading-spinner');
            const settingsModal = document.getElementById('settings-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            
            let recognition;
            let isRecording = false;

            // Speech Recognition Setup
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRec) {
                recognition = new SpeechRec();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (e) => {
                    let finalTranscript = '';
                    for (let i = e.resultIndex; i < e.results.length; ++i) {
                        if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + ' ';
                    }
                    if (finalTranscript) {
                        dictationBox.value += finalTranscript;
                        dictationBox.scrollTop = dictationBox.scrollHeight;
                        summariseBtn.disabled = false;
                    }
                };

                recognition.onend = () => {
                    if (isRecording) recognition.start(); // Auto-restart if not manually stopped
                };
            }

            startBtn.onclick = () => {
                if (!isRecording) {
                    recognition?.start();
                    isRecording = true;
                    statusIndicator.className = "w-4 h-4 bg-red-500 rounded-full glowing-border";
                    startBtn.innerHTML = '<i data-lucide="square"></i> <span>Stop Recording</span>';
                } else {
                    isRecording = false;
                    recognition?.stop();
                    statusIndicator.className = "w-4 h-4 bg-slate-500 rounded-full";
                    startBtn.innerHTML = '<i data-lucide="mic"></i> <span>Start Recording</span>';
                }
                lucide.createIcons();
            };

            // AI Logic
            async function callGemini(text, key, retries = 5, delay = 1000) {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                
                const prompt = `Convert these clinical spoken notes into a formal medical note. 
                Use these headers: CHIEF COMPLAINT, HISTORY, MEDICATIONS, EXAM, PLAN. 
                Wrap any words that seem phonetically ambiguous or like a typo in <<<brackets>>>.
                
                Notes: ${text}`;

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    if (response.status === 404) throw new Error("API Endpoint not found. Please check your model permissions.");
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, delay));
                        return callGemini(text, key, retries - 1, delay * 2);
                    }
                    throw err;
                }
            }

            summariseBtn.onclick = async () => {
                const key = localStorage.getItem('medico_key');
                if (!key) return settingsModal.classList.remove('hidden');

                loadingSpinner.classList.remove('hidden');
                try {
                    const result = await callGemini(dictationBox.value, key);
                    formatSummary(result);
                    document.getElementById('copy-btn').disabled = false;
                    document.getElementById('save-txt-btn').disabled = false;
                } catch (e) {
                    summaryContent.innerHTML = `<p class="text-red-400">Error: ${e.message}</p>`;
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            };

            function formatSummary(text) {
                summaryContent.innerHTML = '';
                const lines = text.split('\n');
                lines.forEach(line => {
                    let processed = line.replace(/<<<(.*?)>>>/g, '<span class="typo-warning">$1</span>');
                    processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    const isHeading = /^[A-Z\s]{4,}:?$/.test(processed.trim().replace(/<[^>]*>/g, ''));
                    
                    const el = document.createElement(isHeading ? 'h3' : 'p');
                    if (isHeading) el.className = 'summary-heading';
                    el.innerHTML = processed;
                    summaryContent.appendChild(el);
                });
            }

            // Settings
            document.getElementById('open-settings-btn').onclick = () => {
                apiKeyInput.value = localStorage.getItem('medico_key') || '';
                settingsModal.classList.remove('hidden');
            };
            document.getElementById('close-settings-btn').onclick = () => settingsModal.classList.add('hidden');
            document.getElementById('save-settings-btn').onclick = () => {
                localStorage.setItem('medico_key', apiKeyInput.value.trim());
                settingsModal.classList.add('hidden');
            };

            // Reset
            document.getElementById('new-session-btn').onclick = () => {
                dictationBox.value = '';
                summaryContent.innerHTML = '';
                summariseBtn.disabled = true;
            };

            // Export
            document.getElementById('copy-btn').onclick = () => {
                const text = summaryContent.innerText;
                navigator.clipboard.writeText(text);
                const originalText = document.getElementById('copy-btn').innerText;
                document.getElementById('copy-btn').innerText = 'Copied!';
                setTimeout(() => document.getElementById('copy-btn').innerText = originalText, 2000);
            };
        });
    </script>
</body>
</html>
